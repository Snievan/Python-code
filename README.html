<!DOCTYPE html>
    <html>
    <head>
        <meta charset="UTF-8">
        <title>0&period; Install</title>
        <style>
</style>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.10.2/dist/katex.min.css" integrity="sha384-yFRtMMDnQtDRO8rLpMIKrtPCD5jdktao2TV19YiZYWMDkUR5GQZR/NOVTdquEx1j" crossorigin="anonymous">
<link href="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.css" rel="stylesheet" type="text/css">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/markdown.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Microsoft/vscode/extensions/markdown-language-features/media/highlight.css">
<style>
            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe WPC', 'Segoe UI', system-ui, 'Ubuntu', 'Droid Sans', sans-serif;
                font-size: 14px;
                line-height: 1.6;
            }
        </style>
        <style>
.task-list-item { list-style-type: none; } .task-list-item-checkbox { margin-left: -20px; vertical-align: middle; }
</style>
        
        <script src="https://cdn.jsdelivr.net/npm/katex-copytex@latest/dist/katex-copytex.min.js"></script>
        
    </head>
    <body class="vscode-body vscode-light">
        <ul>
<li><a href="#0-install">0. Install</a>
<ul>
<li><a href="#pip-install-with-image-site">PIP install with image site</a></li>
</ul>
</li>
<li><a href="#1-system">1. System</a>
<ul>
<li><a href="#os-sys">OS, SYS</a>
<ul>
<li><a href="#mute-warnings">Mute Warnings</a></li>
<li><a href="#get_path_for_file">get_path_for_file</a></li>
<li><a href="#unzip-files">Unzip Files</a></li>
<li><a href="#oswalk">os.walk</a></li>
</ul>
</li>
<li><a href="#ms-office">MS Office</a>
<ul>
<li><a href="#pywin32">pywin32</a></li>
</ul>
</li>
<li><a href="#string">String</a>
<ul>
<li><a href="#decoding">decoding</a></li>
<li><a href="#ordchr">ord,chr</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#2-web-scraping">2. Web Scraping</a></li>
<li><a href="#3-date--time">3. Date &amp; Time</a>
<ul>
<li><a href="#get-timestamp">Get Timestamp</a></li>
<li><a href="#conver-time-zone-in-pd">Conver Time Zone in pd</a></li>
<li><a href="#time-datetime-module">time, datetime module</a></li>
<li><a href="#date-formatting">Date Formatting</a></li>
</ul>
</li>
<li><a href="#4-visualization">4. Visualization</a>
<ul>
<li><a href="#echarts">Echarts</a></li>
<li><a href="#matplotlib">matplotlib</a>
<ul>
<li><a href="#initailizing">initailizing</a></li>
<li><a href="#chinese-enable">Chinese enable</a></li>
<li><a href="#basic-use-case-style">Basic use case: style</a></li>
<li><a href="#multiplots">Multiplots</a></li>
<li><a href="#line-plot">line plot</a></li>
<li><a href="#scatter-plot">Scatter plot</a></li>
<li><a href="#pie-chart">Pie chart</a></li>
<li><a href="#tricks">Tricks</a></li>
</ul>
</li>
<li><a href="#seaborn">seaborn</a>
<ul>
<li><a href="#save-image">Save Image</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#5-binary-operator">5. Binary Operator</a></li>
<li><a href="#6-data-wrangling">6. Data Wrangling</a>
<ul>
<li><a href="#pandas">Pandas</a>
<ul>
<li><a href="#read-data">read data</a></li>
<li><a href="#basic-use-case">Basic Use Case</a></li>
<li><a href="#series">Series'</a></li>
<li><a href="#multiindex">Multiindex</a></li>
<li><a href="#fitering">Fitering</a></li>
<li><a href="#df-grouby">DF grouby()</a></li>
<li><a href="#dfsort_values">df.sort_values()</a></li>
<li><a href="#observation-padding">Observation Padding</a></li>
<li><a href="#pandas-profiling">Pandas Profiling</a></li>
<li><a href="#miscs">Miscs</a>
<ul>
<li><a href="#to_markdown">to_markdown</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#numpy">Numpy</a></li>
<li><a href="#tensor-flow">Tensor flow</a>
<ul>
<li><a href="#basics">Basics</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#7-regular-expression">7. Regular Expression</a>
<ul>
<li><a href="#recomple">re.comple()</a></li>
<li><a href="#latex">Latex</a></li>
</ul>
</li>
<li><a href="#8-formatted-output">8. Formatted output</a></li>
<li><a href="#9-github">9. Github</a></li>
<li><a href="#sql">sql</a>
<ul>
<li><a href="#impala">impala</a></li>
<li><a href="#hive-sql">HIVE sql</a>
<ul>
<li><a href="#one-row-to-many">One row to many</a></li>
<li><a href="#grouping-sets">grouping sets</a></li>
<li><a href="#use-py-code-to-generate-sql">Use py code to generate sql</a></li>
<li><a href="#array-key-relevant">array, key relevant</a></li>
</ul>
</li>
<li><a href="#mysql">mysql</a></li>
</ul>
</li>
</ul>
<p>last update on 2021/5/10</p>
<h1 id="0-install">0. Install</h1>
<h2 id="pip-install-with-image-site">PIP install with image site</h2>
<p>in cmd mode</p>
<pre><code><code><div>pip install impala -i https://pypi.tuna.tsinghua.edu.cn/simple/
</div></code></code></pre>
<h1 id="1-system">1. System</h1>
<h2 id="os-sys">OS, SYS</h2>
<h3 id="mute-warnings">Mute Warnings</h3>
<pre><code class="language-python"><div><span class="hljs-keyword">import</span> os
os.environ[<span class="hljs-string">&#x27;TF_CPP_MIN_LOG_LEVEL&#x27;</span>]=<span class="hljs-string">&#x27;2&#x27;</span>
</div></code></pre>
<h3 id="get_path_for_file">get_path_for_file</h3>
<pre><code><code><div>os.path.join (a,b,c)
</div></code></code></pre>
<h3 id="unzip-files">Unzip Files</h3>
<pre><code class="language-PYTHON"><div><span class="hljs-keyword">import</span> zipfile
path_to_zip_file = <span class="hljs-string">r&#x27;../PHM原型系统.rar&#x27;</span>
directory_to_extract_to = <span class="hljs-string">r&#x27;../&#x27;</span>
<span class="hljs-keyword">with</span> zipfile.ZipFile(path_to_zip_file, <span class="hljs-string">&#x27;r&#x27;</span>) <span class="hljs-keyword">as</span> zip_ref:
    zip_ref.extractall(directory_to_extract_to)
</div></code></pre>
<h3 id="oswalk">os.walk</h3>
<pre><code class="language-PYTHON"><div><span class="hljs-keyword">import</span> os
<span class="hljs-keyword">for</span> root, dirs, files <span class="hljs-keyword">in</span> os.walk(<span class="hljs-string">&quot;.&quot;</span>, topdown=<span class="hljs-literal">False</span>):
    <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> files:
        print(os.path.join(root, name))
    <span class="hljs-keyword">for</span> name <span class="hljs-keyword">in</span> dirs:
        print(os.path.join(root, name))
</div></code></pre>
<h2 id="ms-office">MS Office</h2>
<h3 id="pywin32">pywin32</h3>
<ol>
<li>Open excel, get cell value</li>
</ol>
<pre><code class="language-python"><div><span class="hljs-keyword">from</span> win32com <span class="hljs-keyword">import</span> client
excel = client.Dispatch(<span class="hljs-string">&quot;Excel.Application&quot;</span>)
excel.Visible = <span class="hljs-literal">True</span>
excel.DisplayAlerts = <span class="hljs-literal">False</span>

wb = excel.Workbooks.Open(filename) 
<span class="hljs-keyword">for</span> ws <span class="hljs-keyword">in</span>  wb.Worksheets:
    print(ws.name)

row = ws.usedrange.rows.count
col = ws.usedrange.columns.count
data = ws.Range(ws.Cells(<span class="hljs-number">1</span>,<span class="hljs-number">1</span>),ws.Cells(row,col)).value
</div></code></pre>
<ol start="2">
<li>Add hyper link</li>
</ol>
<pre><code class="language-PYTHON"><div><span class="hljs-keyword">import</span> os

<span class="hljs-keyword">from</span> win32com <span class="hljs-keyword">import</span> client
excel = client.Dispatch(<span class="hljs-string">&quot;Excel.Application&quot;</span>)
excel.Visible = <span class="hljs-literal">True</span>
excel.DisplayAlerts = <span class="hljs-literal">False</span>

file_path_abs =  <span class="hljs-string">r&#x27;file_absoulte_path.xlsx&#x27;</span>

wb = excel.Workbooks.Open(file_path_abs) 
<span class="hljs-keyword">for</span> ws <span class="hljs-keyword">in</span>  wb.Worksheets:
    print(ws.name)
cells_left = [wb.Worksheets(<span class="hljs-string">&quot;数据源&quot;</span>).Cells(i+<span class="hljs-number">3</span>,<span class="hljs-number">4</span>) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">61</span>)]
len(cells_left)

cells_right = [wb.Worksheets(<span class="hljs-string">&quot;ODS字段&quot;</span>).Cells(i+<span class="hljs-number">2</span>,<span class="hljs-number">1</span>) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(<span class="hljs-number">1500</span>) <span class="hljs-keyword">if</span> wb.Worksheets(<span class="hljs-string">&quot;ODS字段&quot;</span>).Cells(i+<span class="hljs-number">2</span>,<span class="hljs-number">1</span>).value]
len(cells_right)
<span class="hljs-keyword">for</span> i,(l,r) <span class="hljs-keyword">in</span> enumerate(zip(cells_left,cells_right)):
    print(i, l.value, r.value,l.value == r.value, r.row)
<span class="hljs-keyword">for</span> i,(l,r) <span class="hljs-keyword">in</span> enumerate(zip(cells_left,cells_right)):
    wb.Worksheets(<span class="hljs-string">&quot;数据源&quot;</span>).Hyperlinks.Add(Anchor = l,
                                    Address = <span class="hljs-string">&quot;&quot;</span>,
                                     SubAddress = <span class="hljs-string">&quot;ODS字段!A&quot;</span>+str(r.row) ,
                                    TextToDisplay = <span class="hljs-string">&quot;&quot;</span>)
    
    wb.Worksheets(<span class="hljs-string">&quot;ODS字段&quot;</span>).Hyperlinks.Add(Anchor = r,
                                    Address = <span class="hljs-string">&quot;&quot;</span>,
                                     SubAddress = <span class="hljs-string">&quot;数据源!D&quot;</span>+str(l.row) ,
                                    TextToDisplay = <span class="hljs-string">&quot;&quot;</span>)
</div></code></pre>
<h2 id="string">String</h2>
<h3 id="decoding">decoding</h3>
<pre><code class="language-python"><div>s = <span class="hljs-string">b&quot;\u8d22\u52a1\u4e2d\u5fc3&quot;</span>
t = s.decode(<span class="hljs-string">&quot;unicode_escape&quot;</span>)
</div></code></pre>
<h3 id="ordchr">ord,chr</h3>
<p>in ascii code int -&gt; char is chr dict, ord for contrast</p>
<h1 id="2-web-scraping">2. Web Scraping</h1>
<p>Here introduce <code>Taland</code>, a powerful extension of Chorm. You can use <code>Taland</code> to test API and params before your coding work get started.</p>
<h1 id="3-date--time">3. Date &amp; Time</h1>
<h2 id="get-timestamp">Get Timestamp</h2>
<pre><code class="language-python"><div><span class="hljs-keyword">import</span> datetime 
<span class="hljs-keyword">import</span> time 

<span class="hljs-comment"># get time stamp</span>
dt = datetime.date(<span class="hljs-number">2020</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>)
dt_tuple = dt.timetuple()
dt_unix = time.mktime(dt_tuple)
</div></code></pre>
<h2 id="conver-time-zone-in-pd">Conver Time Zone in pd</h2>
<pre><code class="language-python"><div>pd.to_datetime(crm_time).tz_convert(<span class="hljs-string">&#x27;Asia/Shanghai&#x27;</span>)
</div></code></pre>
<h2 id="time-datetime-module">time, datetime module</h2>
<p>generate end of day for each month</p>
<pre><code class="language-python"><div><span class="hljs-keyword">import</span> datetime

months = []
<span class="hljs-keyword">for</span> year <span class="hljs-keyword">in</span> (<span class="hljs-number">2019</span>,<span class="hljs-number">2020</span>):
    <span class="hljs-keyword">for</span> month <span class="hljs-keyword">in</span> range(<span class="hljs-number">1</span>,<span class="hljs-number">13</span>):
        first_day = datetime.date(year,month,<span class="hljs-number">1</span>)
        end_day_str = str(first_day + datetime.timedelta(days=<span class="hljs-number">-1</span>))
        months.append(end_day_str)
    
print(months)
</div></code></pre>
<h2 id="date-formatting">Date Formatting</h2>
<p>&quot;2020-5-6&quot;, such format conver to a regular date format</p>
<pre><code class="language-python"><div><span class="hljs-keyword">from</span> dateutil <span class="hljs-keyword">import</span> parser
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">date_parse</span>(<span class="hljs-params">s</span>):</span>
    <span class="hljs-string">&#x27;&#x27;&#x27; Converts a string to a date &#x27;&#x27;&#x27;</span>
    <span class="hljs-keyword">try</span>:
        t = parser.parse(s, parser.parserinfo())
        <span class="hljs-keyword">return</span> t.strftime(<span class="hljs-string">&#x27;%Y-%m-%d&#x27;</span>)
    <span class="hljs-keyword">except</span>:
        <span class="hljs-keyword">return</span> <span class="hljs-literal">None</span>
df_data[<span class="hljs-string">&quot;上课日期&quot;</span>] = df_data[<span class="hljs-string">&quot;上课日期&quot;</span>].apply(date_parse)
</div></code></pre>
<h1 id="4-visualization">4. Visualization</h1>
<h2 id="echarts">Echarts</h2>
<pre><code class="language-python"><div><span class="hljs-keyword">from</span> pyecharts.charts <span class="hljs-keyword">import</span> Bar
<span class="hljs-keyword">from</span> pyecharts <span class="hljs-keyword">import</span> options <span class="hljs-keyword">as</span> opts
<span class="hljs-comment">#from pyecharts.render import make_snapshot</span>
bar = (
    Bar({<span class="hljs-string">&quot;width&quot;</span>: <span class="hljs-string">&quot;800&quot;</span>, <span class="hljs-string">&quot;height&quot;</span>: <span class="hljs-string">&quot;320px&quot;</span>})
    .add_xaxis(list(dau[<span class="hljs-string">&quot;mm&quot;</span>].values) )
    .add_yaxis(<span class="hljs-string">&quot;MAU&quot;</span>, mau_arr )
    .add_yaxis(<span class="hljs-string">&quot;DAU&quot;</span>, dau_arr )
    .set_global_opts(title_opts=opts.TitleOpts(title=<span class="hljs-string">&quot;&quot;</span>,subtitle=<span class="hljs-string">&quot;单位: 万&quot;</span>))
)
bar.render_notebook()<span class="hljs-comment">#在Notebook中进行渲染图像</span>
</div></code></pre>
<h2 id="matplotlib">matplotlib</h2>
<h3 id="initailizing">initailizing</h3>
<pre><code class="language-python"><div>
<span class="hljs-keyword">import</span> seaborn <span class="hljs-keyword">as</span> sns
<span class="hljs-keyword">import</span> matplotlib.pyplot <span class="hljs-keyword">as</span> plt
my_rcParams = {<span class="hljs-string">&#x27;font.sans-serif&#x27;</span>:<span class="hljs-string">&#x27;Microsoft YaHei&#x27;</span>,<span class="hljs-string">&#x27;axes.unicode_minus&#x27;</span>:<span class="hljs-literal">False</span>,<span class="hljs-string">&#x27;savefig.dpi&#x27;</span>:<span class="hljs-number">160</span>,<span class="hljs-string">&#x27;figure.dpi&#x27;</span>:<span class="hljs-number">160</span>}
plt.rcParams.update(my_rcParams)
</div></code></pre>
<h3 id="chinese-enable">Chinese enable</h3>
<pre><code><code><div>import matplotlib.pyplot as plt
## method 1
my_rcParams = {'font.sans-serif':'Microsoft YaHei','axes.unicode_minus':False,'savefig.dpi':160,'figure.dpi':160}
plt.rcParams.update(my_rcParams)
## method 2

from matplotlib.font_manager import FontProperties
font = FontProperties(fname='/System/Library/Fonts/STHeiti Light.ttc', size=16)
# font = FontProperties(family=&quot;YouYuan&quot;, size=16)
ax[0].set_yticklabels(labels=[&quot;美团&quot;,&quot;滴滴&quot;],rotation = 0,fontproperties=font)

</div></code></code></pre>
<h3 id="basic-use-case-style">Basic use case: style</h3>
<pre><code class="language-python"><div>plt.style.use(<span class="hljs-string">&quot;fivethirtyeight&quot;</span>) <span class="hljs-comment">## 风格</span>
plt.xkcd() <span class="hljs-comment">## 风格</span>
plt.figure(<span class="hljs-number">3</span>) 

x_index = np.arange(<span class="hljs-number">5</span>)   <span class="hljs-comment">#柱的索引</span>
x_data = (<span class="hljs-string">&#x27;A&#x27;</span>, <span class="hljs-string">&#x27;B&#x27;</span>, <span class="hljs-string">&#x27;C&#x27;</span>, <span class="hljs-string">&#x27;D&#x27;</span>, <span class="hljs-string">&#x27;E&#x27;</span>)
y1_data = (<span class="hljs-number">20</span>, <span class="hljs-number">35</span>, <span class="hljs-number">30</span>, <span class="hljs-number">35</span>, <span class="hljs-number">27</span>)
y2_data = (<span class="hljs-number">25</span>, <span class="hljs-number">32</span>, <span class="hljs-number">34</span>, <span class="hljs-number">20</span>, <span class="hljs-number">25</span>)
bar_width = <span class="hljs-number">0.35</span>   <span class="hljs-comment">#定义一个数字代表每个独立柱的宽度</span>

rects1 = plt.bar(x_index, y1_data, width=bar_width,alpha=<span class="hljs-number">0.4</span>, color=<span class="hljs-string">&#x27;b&#x27;</span>,label=<span class="hljs-string">&#x27;legend1&#x27;</span>)            <span class="hljs-comment">#参数：左偏移、高度、柱宽、透明度、颜色、图例</span>
rects2 = plt.bar(x_index + bar_width, y2_data, width=bar_width,alpha=<span class="hljs-number">0.5</span>,color=<span class="hljs-string">&#x27;r&#x27;</span>,label=<span class="hljs-string">&#x27;legend2&#x27;</span>) <span class="hljs-comment">#参数：左偏移、高度、柱宽、透明度、颜色、图例</span>
<span class="hljs-comment">#关于左偏移，不用关心每根柱的中心不中心，因为只要把刻度线设置在柱的中间就可以了</span>
plt.xticks(x_index + bar_width/<span class="hljs-number">2</span>, x_data)   <span class="hljs-comment">#x轴刻度线</span>
plt.legend()    <span class="hljs-comment">#显示图例</span>
plt.tight_layout()  <span class="hljs-comment">#自动控制图像外部边缘，此方法不能够很好的控制图像间的间隔</span>
plt.show()
</div></code></pre>
<h3 id="multiplots">Multiplots</h3>
<pre><code class="language-python"><div><span class="hljs-keyword">import</span> pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">from</span> matplotlib <span class="hljs-keyword">import</span> pyplot <span class="hljs-keyword">as</span> plt
tips = pd.read_csv(<span class="hljs-string">r&quot;.\seaborn-data-master\tips.csv&quot;</span>)

fig,(ax1,ax2) = plt.subplots(nrows=<span class="hljs-number">1</span>,ncols=<span class="hljs-number">2</span>,sharey=<span class="hljs-literal">True</span>)
ax1.hist(<span class="hljs-string">&quot;day&quot;</span>,data = tips.query(<span class="hljs-string">&quot;&quot;&quot; sex==&quot;Male&quot; &quot;&quot;&quot;</span>))
ax1.set_xlabel(<span class="hljs-string">&quot;Male counts&quot;</span>)
ax2.hist(<span class="hljs-string">&quot;day&quot;</span>,data = tips.query(<span class="hljs-string">&quot;&quot;&quot; sex==&quot;Female&quot; &quot;&quot;&quot;</span>))
ax2.set_xlabel(<span class="hljs-string">&quot;Female counts&quot;</span>)
</div></code></pre>
<h3 id="line-plot">line plot</h3>
<h3 id="scatter-plot">Scatter plot</h3>
<h3 id="pie-chart">Pie chart</h3>
<pre><code class="language-python"><div>plt.style.use(<span class="hljs-string">&quot;fivethirtyeight&quot;</span>)

slices = [<span class="hljs-number">10</span>,<span class="hljs-number">20</span>,<span class="hljs-number">30</span>,<span class="hljs-number">40</span>,<span class="hljs-number">50</span>]
labels = [<span class="hljs-string">&quot;Java&quot;</span>,<span class="hljs-string">&quot;HTML&quot;</span>,<span class="hljs-string">&quot;SQL&quot;</span>,<span class="hljs-string">&quot;Python&quot;</span>,<span class="hljs-string">&quot;Java&quot;</span>]
explode = [<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0</span>,<span class="hljs-number">0.1</span>,<span class="hljs-number">0</span>]

plt.pie(slices, labels = labels, explode=explode, shadow=<span class="hljs-literal">True</span>, startangle = <span class="hljs-number">90</span>,
    autopct= <span class="hljs-string">&#x27;%1.1f%%&#x27;</span>,
    wedgeprops={<span class="hljs-string">&quot;edgecolor&quot;</span>:<span class="hljs-string">&quot;black&quot;</span>},
    )

plt.title(<span class="hljs-string">&quot;My Pie Chart&quot;</span>)
plt.tight_layout()
plt.show()
</div></code></pre>
<h3 id="tricks">Tricks</h3>
<pre><code><code><div>plt.tight_layout()
plt.figure(figsize=(9, 3)) # size set
ax.legend()                # show legend
plt.xticks(rotation=75)    # rotation
</div></code></code></pre>
<h2 id="seaborn">seaborn</h2>
<pre><code><code><div>g.set_yscale(&quot;log&quot;)
g.fig.get_axes()[0].set_yscale('log')
</div></code></code></pre>
<pre><code><code><div>import seaborn as sns
import matplotlib.pyplot as plt
sns.set(style=&quot;ticks&quot;, color_codes=True)
</div></code></code></pre>
<p>labeL rename\log</p>
<pre><code><code><div>ax = sns.countplot(y=&quot;school_dept&quot;, data = df_week.query(query_expr), color=&quot;b&quot;)
ax.set(xlabel = &quot;xxx&quot;,ylabel = &quot;yyy&quot;)
ax.set_yscale('log',nonposy='mask',subsy=[0])
plt.show()
</div></code></code></pre>
<h3 id="save-image">Save Image</h3>
<pre><code class="language-python"><div>img.savefig(<span class="hljs-string">&quot;test.png&quot;</span>)
</div></code></pre>
<h1 id="5-binary-operator">5. Binary Operator</h1>
<p><code>&lt;&lt;</code>denoete's add 0's to right side, <code>&gt;&gt;</code> means ignore some number's on the right most side</p>
<pre><code class="language-python"><div><span class="hljs-comment">## 190. Reverse Bits</span>
ret, power = <span class="hljs-number">0</span>, <span class="hljs-number">31</span>
<span class="hljs-keyword">while</span> n:
    ret += (n &amp; <span class="hljs-number">1</span>) &lt;&lt; power
    n = n &gt;&gt; <span class="hljs-number">1</span>  
    power -= <span class="hljs-number">1</span>
<span class="hljs-keyword">print</span> (ret)
</div></code></pre>
<h1 id="6-data-wrangling">6. Data Wrangling</h1>
<h2 id="pandas">Pandas</h2>
<h3 id="read-data">read data</h3>
<p>Convert date featrue with timezone</p>
<pre><code class="language-python"><div>date_parser = <span class="hljs-keyword">lambda</span> x: pd.to_datetime(x).tz_convert(<span class="hljs-string">&#x27;Asia/Shanghai&#x27;</span>).date()
class_info = pd.read_csv(<span class="hljs-string">&quot;ClassInformation__c_20201021.csv&quot;</span>,parse_dates = [<span class="hljs-string">&quot;CreatedDate&quot;</span>],date_parser = date_parser)
</div></code></pre>
<h3 id="basic-use-case">Basic Use Case</h3>
<pre><code><code><div>col1 = pd.Series( {1:10,3:10,5:10} )
col2 = pd.Series( {2:20,4:30,5:40,6:50} )

fig, ax = plt.subplots()
ax.plot(col1, label=&quot;dog&quot;)
ax.plot(col2, label=&quot;cat&quot;)
ax.legend()

plt.show()
</div></code></code></pre>
<h3 id="series">Series'</h3>
<pre><code><code><div>df_week[&quot;school_industy&quot;].value_counts()
data['Title'] = data['Title'].replace(['Mme'], 'Miss')
</div></code></code></pre>
<h3 id="multiindex">Multiindex</h3>
<pre><code><code><div>vals = [sr_industry_cnt.loc[industry,i] if (industry,i) in sr_industry_cnt.index else 0 for industry in industry_arr]
</div></code></code></pre>
<h3 id="fitering">Fitering</h3>
<p>Dataframe.query() function</p>
<pre><code><code><div>import pandas as pd
df = pd.DataFrame({'a':[1, 2, 3, 4, 5, 6],
                   'b':[1, 2, 3, 4, 5, 6],
                   'c':[1, 2, 3, 4, 5, 6]})

query_list = [1, 2]
df_2 = df.query('c not in @query_list')[['a', 'b']]

</div></code></code></pre>
<pre><code><code><div>df[(df.A==100)&amp;(df.B=='a')]
</div></code></code></pre>
<h3 id="df-grouby">DF grouby()</h3>
<pre><code><code><div>grouped = df.groupby('Gender')
grouped_muti = df.groupby(['Gender', 'Age'])

print(grouped.size())
print(grouped_muti.size())

print(grouped.get_group('Female'))
print(grouped_muti.get_group(('Female', 17)))

print(grouped.count())
print(grouped.max()[['Age', 'Score']])
print(grouped.mean()[['Age', 'Score']])


</div></code></code></pre>
<h3 id="dfsort_values">df.sort_values()</h3>
<pre><code><code><div>DataFrame.sort_values(by, axis=0, ascending=True, inplace=False, kind='quicksort', na_position='last')
</div></code></code></pre>
<h3 id="observation-padding">Observation Padding</h3>
<pre><code><code><div>mport pandas as pd

df = pd.DataFrame([['a','x','1'],['a','y','2'],['b','x','3']])
df.columns = ['cat1','cat2','val1']
df.head()


df['join_key'] = 0
df_new = pd.merge(df[['cat1','join_key']].drop_duplicates(),df[['cat2','join_key']].drop_duplicates(),how='outer',on='join_key')
df_new.drop(columns=['join_key'],inplace=True)

df = pd.merge(df_new,df,on = ['cat1','cat2'],how = 'left')
df.drop(columns=['join_key'],inplace=True)
df_new.head()
</div></code></code></pre>
<h3 id="pandas-profiling">Pandas Profiling</h3>
<pre><code class="language-python"><div><span class="hljs-keyword">import</span>  pandas <span class="hljs-keyword">as</span> pd
<span class="hljs-keyword">import</span> pandas_profiling 
<span class="hljs-comment"># read data</span>
titanic = pd.read_csv(<span class="hljs-string">&#x27;https://raw.githubusercontent.com/justmarkham/pandas-videos/master/data/titanic_train.csv&#x27;</span>)

profile = pandas_profiling.ProfileReport(titanic)
profile.to_file(outputfile = <span class="hljs-string">&quot;output_file.html&quot;</span>)
</div></code></pre>
<h3 id="miscs">Miscs</h3>
<h4 id="to_markdown">to_markdown</h4>
<p>df.to_markdown</p>
<pre><code class="language-sql"><div>file_name = r&quot;class_header.csv&quot;
import pandas as pd 
def df_to_md(df):
    md = &quot;&quot;
    header =&quot;|&quot;+  &quot;|&quot;.join(str(c) for c in df.columns) + &quot;|&quot;
    line =  &quot;|&quot; + &quot;|&quot;.join(&quot;-:&quot;for c in df.columns) + &quot;|&quot;
    md += header +&quot;\n&quot;
    md += line +&quot;\n&quot;
    for i, row in df.iterrows():
        md += &quot;|&quot;+ &quot;|&quot;.join(str(s) for s in row) + &quot;|&quot; + &quot;\n&quot;
    print(md)
    return md

df =  pd.read_csv(file_name, encoding = &#x27;utf-8&#x27;)
<span class="hljs-keyword">with</span> <span class="hljs-keyword">open</span>(r<span class="hljs-string">&quot;mk_table.txt&quot;</span>,<span class="hljs-string">&quot;w&quot;</span>) <span class="hljs-keyword">as</span> f:
    f.write(df_to_md(df))

</div></code></pre>
<h2 id="numpy">Numpy</h2>
<h2 id="tensor-flow">Tensor flow</h2>
<h3 id="basics">Basics</h3>
<pre><code class="language-python"><div><span class="hljs-keyword">import</span> tensorflow <span class="hljs-keyword">as</span> tf
msg = tf.constant(<span class="hljs-string">&quot;Hello world&quot;</span>)
<span class="hljs-keyword">with</span> tf.Session() <span class="hljs-keyword">as</span> sess:
    print(sess.run(msg).decode())

sess = tf.InteractiveSession()
A = tf.Variable(tf.random_normal([<span class="hljs-number">5</span>,<span class="hljs-number">10</span>]))
A.initializer.run()
</div></code></pre>
<h1 id="7-regular-expression">7. Regular Expression</h1>
<h2 id="recomple">re.comple()</h2>
<pre><code><code><div>import re 
s = &quot;a good   example&quot;
regex  = re.compile('\s+')
res = regex.split(s)
print(res)
</div></code></code></pre>
<h2 id="latex">Latex</h2>
<p><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>y</mi><mo>=</mo><msup><mi>x</mi><mn>2</mn></msup><mo>+</mo><mn>5</mn></mrow><annotation encoding="application/x-tex">y = x^2 + 5</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.19444em;"></span><span class="mord mathdefault" style="margin-right:0.03588em;">y</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.897438em;vertical-align:-0.08333em;"></span><span class="mord"><span class="mord mathdefault">x</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141079999999999em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.64444em;vertical-align:0em;"></span><span class="mord">5</span></span></span></span></p>
<h1 id="8-formatted-output">8. Formatted output</h1>
<pre><code><code><div>train_stop_threshold = 0.8
print(&quot;\nreached accuracy of {:0.1f}%&quot;.format(0.952*100))
</div></code></code></pre>
<pre><code class="language-python"><div>print(<span class="hljs-string">&quot;Worksheet Count: \t&quot;</span>,wb.Worksheets.count)
print(<span class="hljs-string">&quot;Sheetname\t\t\trows\tcols&quot;</span>)
print(<span class="hljs-string">&quot;-&quot;</span>*<span class="hljs-number">48</span>)
<span class="hljs-keyword">for</span> ws <span class="hljs-keyword">in</span>  wb.Worksheets:
    ws_info = {<span class="hljs-string">&quot;name&quot;</span> : ws.name,
          <span class="hljs-string">&quot;rows&quot;</span>:ws.usedrange.rows.count,
          <span class="hljs-string">&quot;cols&quot;</span>:ws.usedrange.columns.count}
    print(<span class="hljs-string">&quot;{name:&lt;30s}\t {rows:&gt;6,d}\t{cols:&gt;6,d}&quot;</span>.format(**ws_info) )
</div></code></pre>
<h1 id="9-github">9. Github</h1>
<p>Use Basics</p>
<p>set environment
documents references: <a href="https://blog.csdn.net/weixin_39691535/article/details/89466062">https://blog.csdn.net/weixin_39691535/article/details/89466062</a></p>
<pre><code class="language-cmd"><div>git init

</div></code></pre>
<h1 id="sql">sql</h1>
<h2 id="impala">impala</h2>
<p>use python to access</p>
<pre><code class="language-python"><div><span class="hljs-keyword">from</span> impala.dbapi <span class="hljs-keyword">import</span> connect
<span class="hljs-keyword">from</span> impala.util <span class="hljs-keyword">import</span> as_pandas

<span class="hljs-comment"># 需要注意的是这里的auth_mechanism必须有，默认是NOSASL，但database不必须，user也不必须</span>
conn = connect(host=<span class="hljs-string">&#x27;172.16.250.1&#x27;</span>, port=<span class="hljs-number">61102</span>, database=<span class="hljs-string">&#x27;default&#x27;</span>, auth_mechanism=<span class="hljs-string">&#x27;PLAIN&#x27;</span>, user=<span class="hljs-string">&#x27;hive&#x27;</span>)
cur = conn.cursor()

sql = <span class="hljs-string">&quot;&quot;&quot;SELECT * FROM liwenhe.class_student_daily limit 10 &quot;&quot;&quot;</span>

cur.execute(sql)
data = as_pandas(cur)
</div></code></pre>
<h2 id="hive-sql">HIVE sql</h2>
<h3 id="one-row-to-many">One row to many</h3>
<pre><code class="language-sql"><div><span class="hljs-keyword">SELECT</span> lv.* 
<span class="hljs-keyword">FROM</span>   ( <span class="hljs-keyword">SELECT</span> <span class="hljs-number">0</span>) t 
<span class="hljs-keyword">lateral</span> <span class="hljs-keyword">VIEW</span> <span class="hljs-keyword">explode</span>(<span class="hljs-built_in">array</span>(<span class="hljs-number">1234567890</span>,<span class="hljs-number">9876543210</span>)) lv <span class="hljs-keyword">AS</span> phone;

<span class="hljs-keyword">SELECT</span> lv.* 
<span class="hljs-keyword">FROM</span>   (<span class="hljs-keyword">SELECT</span> <span class="hljs-number">0</span>) t 
<span class="hljs-keyword">lateral</span> <span class="hljs-keyword">VIEW</span> inline(<span class="hljs-built_in">array</span>(<span class="hljs-keyword">struct</span>(<span class="hljs-string">&#x27;A&#x27;</span>,<span class="hljs-number">10</span>,<span class="hljs-string">&#x27;AAA&#x27;</span>),<span class="hljs-keyword">struct</span>(<span class="hljs-string">&#x27;B&#x27;</span>,<span class="hljs-number">20</span>, <span class="hljs-string">&#x27;BBB&#x27;</span>),<span class="hljs-keyword">struct</span>(<span class="hljs-string">&#x27;B&#x27;</span>,<span class="hljs-number">300</span>, <span class="hljs-string">&#x27;CCC&#x27;</span>) )) lv <span class="hljs-keyword">AS</span> col1, col2, col3;

time generator
```sql
<span class="hljs-keyword">select</span> tf.*,t.*, <span class="hljs-keyword">date_add</span>(start_date,pos) 
<span class="hljs-keyword">from</span> (
  <span class="hljs-keyword">select</span> <span class="hljs-string">&#x27;a&#x27;</span> <span class="hljs-keyword">as</span> a, <span class="hljs-string">&#x27;2018-11-01&#x27;</span> <span class="hljs-keyword">as</span> start_date, <span class="hljs-string">&#x27;2018-12-01&#x27;</span> <span class="hljs-keyword">as</span> end_date 
) t 
<span class="hljs-keyword">lateral</span> <span class="hljs-keyword">view</span> posexplode(<span class="hljs-keyword">split</span>(<span class="hljs-keyword">space</span>(<span class="hljs-keyword">datediff</span>(end_date,start_date)),<span class="hljs-string">&#x27; &#x27;</span>)) tf <span class="hljs-keyword">as</span> pos,val <span class="hljs-keyword">limit</span> <span class="hljs-number">5000</span>
</div></code></pre>
<h3 id="grouping-sets">grouping sets</h3>
<pre><code class="language-sql"><div><span class="hljs-keyword">with</span> <span class="hljs-keyword">data</span> <span class="hljs-keyword">as</span> (
<span class="hljs-keyword">SELECT</span> <span class="hljs-string">&quot;beijing&quot;</span> <span class="hljs-keyword">as</span> city, <span class="hljs-string">&quot;1&quot;</span> <span class="hljs-keyword">as</span> mon, <span class="hljs-string">&quot;10&quot;</span> <span class="hljs-keyword">as</span> val <span class="hljs-keyword">union</span> <span class="hljs-keyword">all</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-string">&quot;beijing&quot;</span> <span class="hljs-keyword">as</span> city, <span class="hljs-string">&quot;2&quot;</span> <span class="hljs-keyword">as</span> mon, <span class="hljs-string">&quot;15&quot;</span> <span class="hljs-keyword">as</span> val <span class="hljs-keyword">union</span> <span class="hljs-keyword">all</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-string">&quot;beijing&quot;</span> <span class="hljs-keyword">as</span> city, <span class="hljs-string">&quot;3&quot;</span> <span class="hljs-keyword">as</span> mon, <span class="hljs-string">&quot;20&quot;</span> <span class="hljs-keyword">as</span> val <span class="hljs-keyword">union</span> <span class="hljs-keyword">all</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-string">&quot;shanghai&quot;</span> <span class="hljs-keyword">as</span> city, <span class="hljs-string">&quot;1&quot;</span> <span class="hljs-keyword">as</span> mon, <span class="hljs-string">&quot;30&quot;</span> <span class="hljs-keyword">as</span> val <span class="hljs-keyword">union</span> <span class="hljs-keyword">all</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-string">&quot;shanghai&quot;</span> <span class="hljs-keyword">as</span> city, <span class="hljs-string">&quot;2&quot;</span> <span class="hljs-keyword">as</span> mon, <span class="hljs-string">&quot;40&quot;</span> <span class="hljs-keyword">as</span> val <span class="hljs-keyword">union</span> <span class="hljs-keyword">all</span>
<span class="hljs-keyword">SELECT</span> <span class="hljs-string">&quot;shanghai&quot;</span> <span class="hljs-keyword">as</span> city, <span class="hljs-string">&quot;3&quot;</span> <span class="hljs-keyword">as</span> mon, <span class="hljs-string">&quot;50&quot;</span> <span class="hljs-keyword">as</span> val)

<span class="hljs-keyword">select</span> 
GROUPING__ID, <span class="hljs-comment">--1city,2mon,3city&amp;mon</span>
city,mon,<span class="hljs-keyword">sum</span>(val) <span class="hljs-keyword">as</span> val
<span class="hljs-keyword">from</span> <span class="hljs-keyword">data</span> 
<span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span> city,mon
<span class="hljs-keyword">grouping</span> <span class="hljs-keyword">sets</span> (city,mon,(city,mon))
<span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> GROUPING__ID,city,mon
</div></code></pre>
<h3 id="use-py-code-to-generate-sql">Use py code to generate sql</h3>
<pre><code class="language-python"><div><span class="hljs-keyword">import</span> datetime 

sql_template = <span class="hljs-string">&quot;&quot;&quot; 
select
&#x27;{}&#x27; as mon,
school_uid,
count(distinct member_uid) as mau,
count(1) as rk_cnt
from  class_student_daily
where time_dd between &#x27;{}&#x27; and &#x27;{}&#x27;
group by school_uid
union all 
&quot;&quot;&quot;</span>
<span class="hljs-comment"># struct st/ed date </span>
months = []
<span class="hljs-keyword">for</span> year <span class="hljs-keyword">in</span> (<span class="hljs-number">2019</span>,<span class="hljs-number">2020</span>):
    <span class="hljs-keyword">for</span> month <span class="hljs-keyword">in</span> range(<span class="hljs-number">1</span>,<span class="hljs-number">13</span>):
        ed_date = datetime.date(year,month,<span class="hljs-number">1</span>) + datetime.timedelta(days = <span class="hljs-number">-1</span>)
        st_date = datetime.date(year,month,<span class="hljs-number">1</span>) + datetime.timedelta(days = <span class="hljs-number">-30</span>)
        months.append((str(st_date),str(ed_date)))

<span class="hljs-comment"># sql strucnt </span>
sql = <span class="hljs-string">&quot;&quot;</span>
<span class="hljs-keyword">for</span> st_date,ed_date <span class="hljs-keyword">in</span> months[<span class="hljs-number">1</span>:<span class="hljs-number">19</span>]:
    sql += sql_template.format(ed_date[:<span class="hljs-number">7</span>],st_date,ed_date)
print(sql[:<span class="hljs-number">100</span>])

filename = <span class="hljs-string">r&#x27;sc_per_mon.sql&#x27;</span> 

<span class="hljs-keyword">with</span> open(filename,<span class="hljs-string">&quot;w&quot;</span>) <span class="hljs-keyword">as</span> f :
    f.write(sql)
print(filename, <span class="hljs-string">&quot;has saved! &quot;</span>)
</div></code></pre>
<h3 id="array-key-relevant">array, key relevant</h3>
<pre><code class="language-sql"><div> <span class="hljs-keyword">select</span> map_keys( <span class="hljs-keyword">map</span>(<span class="hljs-string">&#x27;key1&#x27;</span>,<span class="hljs-string">&#x27;value1&#x27;</span>,<span class="hljs-string">&#x27;key2&#x27;</span>,<span class="hljs-string">&#x27;value2&#x27;</span>,<span class="hljs-string">&#x27;key3&#x27;</span>,<span class="hljs-string">&#x27;value3&#x27;</span>)) <span class="hljs-keyword">as</span> <span class="hljs-keyword">keys</span>;
</div></code></pre>
<p>+-------------------------+--+
|          keys           |
+-------------------------+--+
| [&quot;key1&quot;,&quot;key2&quot;,&quot;key3&quot;]  |
+-------------------------+--+</p>
<pre><code class="language-sql"><div><span class="hljs-keyword">select</span> sort_array(<span class="hljs-built_in">array</span>(<span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">5</span>,<span class="hljs-number">2</span>,<span class="hljs-number">5</span>));
</div></code></pre>
<p>+--------------+--+
|     _c0      |
+--------------+--+
| [1,2,3,5,5]  |
+--------------+--+</p>
<pre><code class="language-sql"><div><span class="hljs-keyword">select</span> <span class="hljs-keyword">size</span>(<span class="hljs-built_in">array</span>(<span class="hljs-number">1</span>,<span class="hljs-number">3</span>,<span class="hljs-number">5</span>,<span class="hljs-number">2</span>,<span class="hljs-number">5</span>));
</div></code></pre>
<p>+------+--+
| _c0  |
+------+--+
| 5    |
+------+--+</p>
<pre><code><code><div>select sentences('Hello there! How are you?');
</div></code></code></pre>
<p>+------------------------------------------+--+
|                   _c0                    |
+------------------------------------------+--+
| [[&quot;Hello&quot;,&quot;there&quot;],[&quot;How&quot;,&quot;are&quot;,&quot;you&quot;]]  |
+------------------------------------------+--+
1 row selected (0.339 seconds)</p>
<h2 id="mysql">mysql</h2>
<p>查看表注释</p>
<pre><code class="language-sql"><div><span class="hljs-keyword">SELECT</span>
table_name 表名,
table_comment 表说明
<span class="hljs-keyword">FROM</span>
information_schema.TABLES
<span class="hljs-keyword">WHERE</span>
table_schema = ‘数据库名’
<span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>
table_name
</div></code></pre>
<p>查看字段注释</p>
<pre><code class="language-sql"><div><span class="hljs-keyword">SELECT</span> 
table_name,
column_name,
column_comment
<span class="hljs-keyword">FROM</span> 
information_schema.COLUMNS <span class="hljs-keyword">WHERE</span>  
TABLE_SCHEMA=<span class="hljs-string">&#x27;eo_oshw&#x27;</span>
<span class="hljs-keyword">and</span> TABLE_NAME = <span class="hljs-string">&#x27;eeo_course_homework&#x27;</span>

</div></code></pre>

    </body>
    </html>